# 传奇MUD游戏

基于传奇2题材的纯文字MUD网页游戏。

## 快速开始

### 1. 启动数据库
```bash
docker-compose up -d
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 运行数据库迁移（可选）
如果是首次运行或需要更新数据库结构：
```bash
# 手动执行SQL迁移文件
psql -h localhost -U mud_user -d mud_game < database/migrations/001_add_skill_proficiency.sql
```

### 4. 运行服务器
```bash
python -m backend.main
```

### 5. 访问游戏
打开浏览器访问 http://localhost:8000

## 功能特性

### 已实现功能

#### 基础系统
- 用户注册/登录（JWT认证）
- 角色创建（战士/法师/道士）
- WebSocket实时通信
- 世界聊天

#### 地图系统
- **24x24随机迷宫生成**（已优化）
- **智能视野迷雾系统**（已修复）
  - 未探索区域不可直接通行
  - 阴影区域需要探索后才能移动
- A*寻路算法验证路径可达性
- 点击移动
- **多地图入口选择**（已完善）
- 地图切换（沃玛、僵尸洞、猪洞、祖玛等16+地图）
- 一键回城
- **怪物只刷新在可到达位置**（已修复）

#### 战斗系统
- PVE回合制战斗
- 战斗日志逐条播放
- 经验/金币/物品掉落
- **怪物定时自动刷新**（已修复）
- Boss系统

#### 物品系统
- 5种品质（白/绿/蓝/紫/红）
- **200格背包 + 1000格仓库**（显示可用空间）
- **完整装备系统**（10个装备槽位）
  - 武器、头盔、衣服、腰带、鞋子
  - 项链、左右戒指、左右手镯
- **综合属性面板**（显示装备加成后的属性）
- 装备穿戴和卸下
- 物品回收（金币/元宝）
- **完整的装备和物品数据**（已补充）

#### 技能系统
- 三职业技能树
- **技能面板优化**（完整显示所有技能）
- **已学习/未学习区域分离**（已改进）
- **技能熟练度系统（0-1000，每1000升1级）**（已实现）
- 基础技能商店购买
- 高级技能怪物掉落
- 技能等级上限3级
- 技能描述和属性完整显示

#### PVP系统
- 野外自由PK
- 红名系统
- 死亡掉落

#### 行会系统
- 创建行会
- 行会成员管理
- 行会聊天

#### 角色成长系统
- **职业差异化成长**（已强化）
  - 战士：每级+25HP/+5MP/+4攻击/+3防御
  - 法师：每级+10HP/+20MP/+5攻击/+1防御
  - 道士：每级+15HP/+15MP/+3攻击/+2防御
- **升级经验指数增长**（难度渐进）
- 每10级额外+1幸运值
- 升级自动满血满蓝
- 装备属性加成系统
- 品质影响装备属性

#### 充值系统
- 元宝充值（模拟）
- VIP等级
- 元宝商城

## 技术栈

- 后端: Python 3.11+ / FastAPI / WebSocket
- 数据库: PostgreSQL + Redis
- 前端: HTML + CSS + JavaScript + Canvas
- 响应式设计: 支持手机/平板/桌面端

## 项目结构

```
mud-legend/
├── backend/
│   ├── main.py              # FastAPI入口
│   ├── config.py            # 配置
│   ├── database.py          # 数据库连接
│   ├── auth.py              # JWT认证
│   ├── schemas.py           # Pydantic模型
│   ├── models/              # 数据库模型
│   │   ├── character.py     # 角色模型
│   │   ├── inventory.py     # 物品/技能模型
│   │   └── ...
│   ├── game/                # 游戏逻辑
│   │   ├── engine.py        # 游戏引擎
│   │   ├── combat.py        # 战斗系统
│   │   ├── map_manager.py   # 地图管理
│   │   ├── maze.py          # 迷宫生成
│   │   ├── pvp.py           # PVP系统
│   │   ├── spawner.py       # 怪物刷新
│   │   └── data_loader.py   # 数据加载
│   ├── api/
│   │   └── recharge.py      # 充值API
│   └── websocket/
│       └── manager.py       # WebSocket管理
├── frontend/
│   ├── index.html
│   ├── css/style.css
│   └── js/game.js
├── data/                    # 游戏配置数据
│   ├── maps/
│   │   └── maps.json        # 地图配置（含多入口）
│   ├── monsters/
│   │   └── monsters.json    # 怪物数据（已补充完整）
│   ├── items/
│   │   ├── weapons.json     # 武器数据（已补充）
│   │   ├── armors.json      # 防具数据（已补充）
│   │   ├── accessories.json # 饰品数据（已补充）
│   │   └── consumables.json # 消耗品数据（已补充）
│   ├── skills/
│   │   ├── warrior.json     # 战士技能（已完善）
│   │   ├── mage.json        # 法师技能（已完善）
│   │   └── taoist.json      # 道士技能（已完善）
│   ├── npcs/
│   │   └── shops.json       # 商店NPC
│   └── config/
│       └── quality.json     # 品质配置
├── database/
│   └── migrations/          # 数据库迁移文件
│       └── 001_add_skill_proficiency.sql
├── plans/
│   └── mud-game-plan.md     # 设计文档
├── requirements.txt
├── docker-compose.yml
└── README.md
```

## 游戏指南

### 职业选择
- **战士**: 高血量高防御，近战物理输出
- **法师**: 低血量高魔法，远程魔法输出
- **道士**: 平衡型，可治疗可召唤

### 地图
- **主城（比奇省）**: 安全区，所有NPC，多个地图入口可选
- **沃玛森林** → 沃玛寺庙1-3层（沃玛教主）
- **僵尸洞1-3层**（尸王）
- **蜈蚣洞1-2层**

### 操作
- 点击地图格子移动（24x24格子）
- 点击怪物攻击
- 到达入口可选择进入对应地图
- 技能界面显示已学习和未学习技能
- 使用技能可增加熟练度，满1000升级

### 技能系统
- 学习技能后自动显示在"已学习"区域
- 每个技能最高3级
- 通过使用技能增加熟练度（每次+10）
- 熟练度达到1000自动升级

## 配置说明

所有游戏数据都在 `data/` 目录下的JSON文件中，可自由修改：

- `maps/maps.json` - 地图配置（含入口设置）
- `monsters/monsters.json` - 怪物属性（完整数据）
- `items/*.json` - 物品属性（武器、防具、饰品、消耗品）
- `skills/*.json` - 技能属性（战士、法师、道士）
- `config/quality.json` - 品质配置

## 最近更新

### v1.3.2 (2026-01-05) - 移动端适配
- ✅ **响应式布局**
  - 手机端自适应地图尺寸
  - 游戏界面纵向排列
  - 弹窗自适应屏幕宽度
  - 背包网格3列显示
  - 技能面板优化布局

### v1.3.1 (2026-01-04) - 地图系统重构
- ✅ **彻底重写地图生成系统**
  - 改用开放式地图生成（约70%通路，30%墙壁）
  - 保证从入口到出口有明确且宽敞的通路
  - 移除了导致孤立区域的递归回溯算法
  - 入口和出口周围3x3区域强制清空
  
- ✅ **怪物刷新系统优化**
  - 简化刷新逻辑，移除A*验证（性能优化）
  - 只在有2个以上相邻通路的位置刷新怪物
  - 避开入口/出口附近5x5区域
  - 确保普通怪物正常生成（测试显示60/60正常）
  
- ✅ **测试验证**
  - 通路占比：68.4%（足够的移动空间）
  - 入口和出口100%可通行
  - 怪物生成率：100%
  - 地图完全可用，战斗系统正常

### v1.3.0 (2026-01-04)
- ✅ **地图系统优化**
  - 修复地图入口位置确保可到达
  - 怪物和Boss只刷新在可到达的路径上
  - 使用A*寻路算法验证位置可达性
  - 优化怪物重新刷新机制
  
- ✅ **背包和仓库改进**
  - 显示可用空间信息（已使用/总容量）
  - 背包200格，仓库1000格
  - 实时更新空间使用情况
  
- ✅ **视野迷雾系统修复**
  - 未探索区域无法直接点击通行
  - 墙壁位置显示提示信息
  - 提升探索体验和安全性
  
- ✅ **技能面板优化**
  - 改进CSS样式确保内容完整显示
  - 区分已学习和未学习技能
  - 优化滚动和布局
  - 技能描述完整显示
  
- ✅ **装备系统完整实现**
  - 10个装备槽位（武器、头盔、衣服、腰带、鞋子、项链、左右戒指、左右手镯）
  - 装备界面显示所有装备槽
  - 综合属性面板（等级、生命、魔法、攻击、防御、幸运）
  - 装备属性加成系统
  - 品质系统影响装备属性
  
- ✅ **角色成长系统强化**
  - 升级经验需求指数增长
  - 不同职业获得不同属性加成
    - 战士：高生命、高防御、中攻击
    - 法师：高魔法、高攻击、低防御
    - 道士：平衡型成长
  - 每10级额外获得1点幸运值
  - 升级自动恢复满状态
  - 详细的升级信息反馈

### v1.2.0 (2026-01-03)
- ✅ 地图尺寸从12x12扩展到24x24
- ✅ 修复怪物刷新系统
- ✅ 实现多入口地图选择机制
- ✅ 完善技能系统（已学习标识、熟练度升级）
- ✅ 补充完整的怪物数据（25+种怪物）
- ✅ 补充完整的装备数据（武器、防具、饰品）
- ✅ 补充完整的技能数据（三职业共20+技能）
- ✅ 数据库迁移文件生成

## 开发说明

### 数据库迁移
执行新的迁移文件以更新数据库结构：
```bash
psql -h localhost -U mud_user -d mud_game < database/migrations/001_add_skill_proficiency.sql
```

### 添加新内容
1. **新怪物**: 编辑 `data/monsters/monsters.json`
2. **新装备**: 编辑 `data/items/` 下对应文件
3. **新技能**: 编辑 `data/skills/` 下对应职业文件
4. **新地图**: 编辑 `data/maps/maps.json`

## 技术特点

- 24x24动态迷宫生成
- 实时怪物刷新系统
- 多入口地图传送机制
- 技能熟练度渐进式升级
- 完整的游戏数据体系

## 故障排除

### 怪物不刷新
- 确认服务器启动时spawner已启动
- 检查控制台是否有错误信息

### 地图入口不显示
- 确认 `data/maps/maps.json` 配置正确
- 检查地图实例是否正确加载

### 技能无法学习
- 确认等级是否满足要求
- 检查金币是否足够
- 确认该技能是否已学习

## 许可证

MIT License